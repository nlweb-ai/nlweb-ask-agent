services:
  # Search Components - Shared React component library (watch mode)
  search-components:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && pnpm dev"
    volumes:
      - ../search-components:/app
      - search-components-node-modules:/app/node_modules
    healthcheck:
      test: ["CMD", "test", "-d", "/app/dist"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s
    networks:
      - nlweb-network

  # Ask API - REST/MCP/A2A server
  ask-api:
    build:
      context: ./ask_api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - ./ask_api/.env
    volumes:
      - ~/.azure:/root/.azure
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - NLWEB_CONFIG_DIR=/app
    networks:
      - nlweb-network
    restart: unless-stopped

  # Chat App - React frontend with Vite dev server
  chat-app:
    build:
      context: ./chat-app
      dockerfile: Dockerfile.dev
      args:
        - GIT_TOKEN=${GIT_TOKEN}
    ports:
      - "5173:5173"
    volumes:
      - ./chat-app/src:/app/src
      - ./chat-app/public:/app/public
      - ./chat-app/index.html:/app/index.html
      # Mount search-components dist into node_modules for local development
      - ../search-components/dist:/app/node_modules/@nlweb-ai/search-components/dist
      - ../search-components/package.json:/app/node_modules/@nlweb-ai/search-components/package.json:ro
    environment:
      - VITE_ASK_API_URL=http://ask-api:8000
    depends_on:
      ask-api:
        condition: service_started
      search-components:
        condition: service_healthy
    networks:
      - nlweb-network

  # Crawler Master - API + Scheduler
  crawler-master:
    build:
      context: ./crawler
      dockerfile: Dockerfile
    command: [".venv/bin/python", "code/core/api.py"]
    ports:
      - "5001:5001"
    env_file:
      - ./crawler/.env
    environment:
      - DOCKER_COMPOSE=true
      - QUEUE_DIR=/app/data/queue
      - QUEUE_TYPE=file
    volumes:
      - ./crawler/data:/app/data
      - ~/.azure:/root/.azure
    networks:
      - nlweb-network

  # Crawler Worker - Queue processor
  crawler-worker:
    build:
      context: ./crawler
      dockerfile: Dockerfile
    command: [".venv/bin/python", "code/core/worker.py"]
    env_file:
      - ./crawler/.env
    environment:
      - QUEUE_DIR=/app/data/queue
      - QUEUE_TYPE=file
    volumes:
      - ./crawler/data:/app/data
      - ~/.azure:/root/.azure
    depends_on:
      - crawler-master
    deploy:
      replicas: 1  # Single worker to avoid race conditions
    networks:
      - nlweb-network

networks:
  nlweb-network:
    driver: bridge

volumes:
  search-components-node-modules:  # Persist node_modules to avoid reinstall on rebuild
